input {
  file {
    path => "/usr/share/logstash/files/afp-case-verification/*"
    start_position => "beginning"
    type => "afp_case_verification"
  }
}

filter {
  if [type] == "afp_case_verification"{
    csv {
      autodetect_column_names => true
      autogenerate_column_names => false
    }
    date {
      match => ["starttime","yyyy-MM-dd'T'HH:mm:ss.SSSZZ"]
      target => "starttime"
    }
    date {
      match => ["endtime","yyyy-MM-dd'T'HH:mm:ss.SSSZZ"]
      target => "endtime" 
    }
    mutate {
      lowercase => ["states"]
      gsub => [
        # remove all comma
        "states", ",", ""
      ]
    }
  }
}

output {
  if [type] == "afp_case_verification" {
    elasticsearch {
      index => "afp_case_verification_data_raw"
      manage_template => true
      document_id => "%{epid_num}"
      template => "/usr/share/logstash/mapping/afp_case_verification_mapping.json"
      template_name => "afp_case_verification"
      hosts => "${ES_HOST}"
    }
    jdbc {
      connection_string => "${JDBC_STRING}/eoc_data"
      username => "${PSQL_USER}"
      password => "${PSQL_PASSWORD}"
      statement => [
        'INSERT INTO public.afp_case_verification(
          starttime, endtime, today, deviceid, gps1, gps1_latitude, gps1_longitude, gps1_altitude, gps1_precision, date_case_verified, 
          date_onset, zones, states, epid, epid_generate, "extract", epid_num, note1, lgas, wards, ward_code, verify_person, 
          verify_person_other, verify_title, verify_title_other, town_city, address, settlement_vill, afp_name, father_name, mother_name, 
          informant, relate_inform, dob, age_years, age_months, sex, setting, setting_other, religion, religion_other, other_child, lang_hh, 
          lang_hh_other, lang_area, lang_area_other, normadic, normad_type, normad_type_other, child_travel30, num_lga_child_visited, travel1, 
          travel1date, travel2, travel2date, travel3, travel3date, travel4, travel4date, fever_onset, asymetric, progmaxim, ascend_paralysis, 
          history_injection, inject_date, admit_hosp, admit_date, med_record, facility_name, seek_help, place1, place1person, place1date, 
          place2, place2person, place2date, place3, place3person, place3date, place4, place4person, place4date, riopv, reason_ri_zero, hist_opv, 
          siaopv, reason_sia_zero, reason_sia_zero_other, ipv_ri_sia, ipvdate, opv_birth, opv1date, opv2date, opv3date, opv4date, last_opv_date, 
          gps2, gps2_latitude, gps2_longitude, gps2_altitude, gps2_precision, stool1date, stool2date, specimen_reach_lab, "DateStoolSentolab", 
          "inv1stDate", rul_tone, rll_tone, lul_tone, lll_tone, rul_reflex, rll_reflex, lul_reflex, lll_reflex, intcranal, "incranRight", 
          "incranLeft", int_muscle, int_pain, "inv1stName", "inv1stTitle", "inv1stTitle_other", verify_afp, phys_diagnosis, phys_diagnosis_other, 
          "diagDescrip", pyhsician, "phyImpression", "phyImpression_other", "hotCase", "hotDsno", "otherNotes", "meta_instanceID", id, uuid, 
          index, parent_table_name, parent_index, tags, notes, version, duration, submitted_by, child_seen, history_flacid, zone_onset, 
          zones_staff, "summary1_Inadequate", "summary1_AgeInDays", verify_impression, reflexes, "site_paralysis_None", "site_paralysis_LUL", 
          "Received_RI", tone, "site_paralysis_RLL", childabsent_other, lga_onset, power, reason_ri_zero_other, injection_serve_other, 
          region_of_case, "normad_type_Farmers", "normad_type_Fishermen", provision_diag, relate_inform_other, lga_notification, 
          totalpoliodoses, zone_notification, medical_doctor, int_district, yesdob, site_paralysis, injection_serve, "summary1_HotCase", 
          "summary1_Approp_Imm", childabsent, state_onset, verify_impression_other, "DateNotified", states_staff, "site_paralysis_LLL", 
          "site_paralysis_RUL", caregiver_know_2ndstool, justification, num_place_visited, normad_type_other1, "SourceInfo_RI", 
          "normad_type_Herdsmen", ward_onset, "interviewed_by_DSNO", stool24, ward_notification, int_bor, int_border, state_notification)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 
                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 
                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 
                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 
                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 
                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 
                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 
                ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);', 
        starttime, endtime, today, deviceid, gps1, gps1_latitude, gps1_longitude, gps1_altitude, gps1_precision, date_case_verified, 
        date_onset, zones, states, epid, epid_generate, "extract", epid_num, note1, lgas, wards, ward_code, verify_person, 
        verify_person_other, verify_title, verify_title_other, town_city, address, settlement_vill, afp_name, father_name, mother_name, 
        informant, relate_inform, dob, age_years, age_months, sex, setting, setting_other, religion, religion_other, other_child, lang_hh, 
        lang_hh_other, lang_area, lang_area_other, normadic, normad_type, normad_type_other, child_travel30, num_lga_child_visited, travel1, 
        travel1date, travel2, travel2date, travel3, travel3date, travel4, travel4date, fever_onset, asymetric, progmaxim, ascend_paralysis, 
        history_injection, inject_date, admit_hosp, admit_date, med_record, facility_name, seek_help, place1, place1person, place1date, 
        place2, place2person, place2date, place3, place3person, place3date, place4, place4person, place4date, riopv, reason_ri_zero, hist_opv, 
        siaopv, reason_sia_zero, reason_sia_zero_other, ipv_ri_sia, ipvdate, opv_birth, opv1date, opv2date, opv3date, opv4date, last_opv_date, 
        gps2, gps2_latitude, gps2_longitude, gps2_altitude, gps2_precision, stool1date, stool2date, specimen_reach_lab, "DateStoolSentolab", 
        "inv1stDate", rul_tone, rll_tone, lul_tone, lll_tone, rul_reflex, rll_reflex, lul_reflex, lll_reflex, intcranal, "incranRight", 
        "incranLeft", int_muscle, int_pain, "inv1stName", "inv1stTitle", "inv1stTitle_other", verify_afp, phys_diagnosis, phys_diagnosis_other, 
        "diagDescrip", pyhsician, "phyImpression", "phyImpression_other", "hotCase", "hotDsno", "otherNotes", "meta_instanceID", id, uuid, 
        index, parent_table_name, parent_index, tags, notes, version, duration, submitted_by, child_seen, history_flacid, zone_onset, 
        zones_staff, "summary1_Inadequate", "summary1_AgeInDays", verify_impression, reflexes, "site_paralysis_None", "site_paralysis_LUL", 
        "Received_RI", tone, "site_paralysis_RLL", childabsent_other, lga_onset, power, reason_ri_zero_other, injection_serve_other, 
        region_of_case, "normad_type_Farmers", "normad_type_Fishermen", provision_diag, relate_inform_other, lga_notification, totalpoliodoses, 
        zone_notification, medical_doctor, int_district, yesdob, site_paralysis, injection_serve, "summary1_HotCase", "summary1_Approp_Imm", 
        childabsent, state_onset, verify_impression_other, "DateNotified", states_staff, "site_paralysis_LLL", "site_paralysis_RUL", 
        caregiver_know_2ndstool, justification, num_place_visited, normad_type_other1, "SourceInfo_RI", "normad_type_Herdsmen", ward_onset, 
        "interviewed_by_DSNO", stool24, ward_notification, int_bor, int_border, state_notification
      ]
    }
  }
}